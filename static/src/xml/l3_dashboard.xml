<templates xml:space="preserve">
  <t t-name="custom.l3_dashboard" owl="1">
    <style>
      .project-info {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .info-row {
        display: grid;
        grid-template-columns: 120px 150px 80px 150px;
        align-items: center;
        gap: 16px; /* masofani boshqarish uchun */
      }

      .label {
        font-weight: 600;
        white-space: nowrap;
      }

      .value {
        text-align: left;
        white-space: nowrap;
      }
    </style>

    <div class="dash l3-dashboard">
      <!-- Project Info -->
      <div class="card card--section mb-3">
        <div class="card-title">Project Information</div>
        <div class="card-body project-info">
          
          <div class="info-row">
            <div class="label">Project Name</div>
            <div class="value"><t t-esc="state.project.name"/></div>
          </div>

          <div class="info-row">
            <div class="label">Customer</div>
            <div class="value"><t t-esc="state.project.customer"/></div>
          </div>

          <div class="info-row">
            <div class="label">Start Date</div>
            <div class="value"><t t-esc="state.project.start_date"/></div>
            <div class="label">Margin %</div>
            <div class="value"><t t-esc="this.formatPercent(this.marginPctTotals(state.project))"/></div>
          </div>

          <div class="info-row">
            <div class="label">End Date</div>
            <div class="value"><t t-esc="state.project.end_date"/></div>
            <div class="label">Margin</div>
            <div class="value"><t t-esc="this.formatNumber(this.marginTotals(state.project))"/></div>
          </div>

        </div>
      </div>

      <!-- Main Table -->
      <div class="card">
        <div class="table-wrap">
          <table class="dash-table">
          <!-- THEAD: replace your current <thead> -->
            <thead>
              <tr>
                <th>Milestone / Description</th>
                <th style="width: 100px;">Date</th>
                <th>Invoiced</th>
                <th>Collected</th>
                <th class="twoline" style="width: 50px;">Pending<br/>Collection</th>
                <th class="twoline" style="width: 50px;">Outstanding<br/>Aging</th>
                <th class="twoline">Vendor<br/>Invoice</th>
                <th class="twoline">Payment<br/>Made</th>
                <th style="width: 50px;">Payment to<br/>be Made</th>
                <th class="twoline">Payroll<br/>Cost</th>
                <!-- NEW -->
                <th class="twoline">Total<br/>Cost</th>
                <!-- <th>Margin</th>
                <th>Margin %</th> -->
              </tr>
            </thead>
  
            <tbody>
              <!-- LOOP ROW: replace your current <t t-foreach=...> block -->
              <t t-foreach="state.project.milestones || []" t-as="m" t-key="m.id">
                <tr>
                  <td class="sticky-col text-start"><t t-esc="m.description"/></td>
                  <td><t t-esc="m.date"/></td>
                  <td class="text-end"><t t-esc="this.formatNumber(m.invoiced)"/></td>
                  <td class="text-end"><t t-esc="this.formatNumber(m.collected)"/></td>
                  <td class="text-end" t-att-class="m.pending_collection &gt; 0 ? 'text-danger' : ''">
                    <t t-esc="this.formatNumber(m.pending_collection)"/>
                  </td>
                  <td><t t-esc="m.outstanding_aging"/></td>
                  <td class="text-end"><t t-esc="this.formatNumber(m.vendor_invoice)"/></td>
                  <td class="text-end"><t t-esc="this.formatNumber(m.payment_made)"/></td>
                  <td class="text-end"><t t-esc="this.formatNumber(m.payment_to_be_made)"/></td>
                  <td class="text-end"><t t-esc="this.formatNumber(m.payroll_cost || 0)"/></td>
            
                  <!-- NEW computed cells -->
                  <td class="text-end"><t t-esc="this.formatNumber(this.totalCost(m))"/></td>
                  <!-- <td class="text-end" t-att-class="this.margin(m) &lt; 0 ? 'text-danger' : ''">
                    <t t-esc="this.formatNumber(this.margin(m))"/>
                  </td>
                  <td class="text-end"><t t-esc="this.formatPercent(this.marginPct(m))"/></td> -->
                </tr>
              </t>
            
              <!-- TOTALS ROW: separate row AFTER the loop -->
              <tr class="bg-accent fw-bold">
                <td class="sticky-col text-start">Total</td>
                <td></td>
                <td class="text-end"><t t-esc="this.formatNumber(state.project.total_invoiced)"/></td>
                <td class="text-end"><t t-esc="this.formatNumber(state.project.total_collected)"/></td>
                <td class="text-end"><t t-esc="this.formatNumber(state.project.total_pending_collection)"/></td>
                <td></td>
                <td class="text-end"><t t-esc="this.formatNumber(state.project.total_vendor_invoice)"/></td>
                <td class="text-end"><t t-esc="this.formatNumber(state.project.total_payment_made)"/></td>
                <td class="text-end"><t t-esc="this.formatNumber(state.project.total_payment_to_be_made)"/></td>
                <td class="text-end"><t t-esc="this.formatNumber(state.project.total_payroll_cost || 0)"/></td>
            
                <!-- NEW totals -->
                <td class="text-end"><t t-esc="this.formatNumber(this.totalCostTotals(state.project))"/></td>
                <!-- <td class="text-end" t-att-class="this.marginTotals(state.project) &lt; 0 ? 'text-danger fw-bold' : 'fw-bold'">
                  <t t-esc="this.formatNumber(this.marginTotals(state.project))"/>
                </td>
                <td class="text-end fw-bold"><t t-esc="this.formatPercent(this.marginPctTotals(state.project))"/></td> -->
              </tr>
            </tbody>
  
          </table>
        </div>
        <div class="p-2 muted small">Figures are project currency unless noted.</div>
      </div>
    </div>
  </t>
</templates>
